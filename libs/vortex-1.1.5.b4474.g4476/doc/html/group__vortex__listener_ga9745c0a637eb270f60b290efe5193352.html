<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>Vortex Library, BEEP Core implementation, RFC 3080 / RFC 3081, XML-RPC, XML-RPC over BEEP, RFC 3529, BEEP Framework, BEEP protocol, BEEP, BEEP library, BEEP libraries, beepcore (Servidores Linux http://www.aspl.es)</title>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-123192-2";
urchinTracker();
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="vortex.css" rel="stylesheet" type="text/css">
</head>
  <body>
    <div class="af-arch-header">
     <img src="main-page-logo.png" > <a href="http://www.aspl.es"><img class="aspl-logo-header" src="aspl-logo-header.png"></a>
    </div>
    <div class="ads">
    <iframe src="http://www.aspl.es/web-ads/index.php?hcolor=fdff4f&amp;fsize=10&amp;bg=555753&amp;fg=ffffff&amp;width=800&amp;height=90" scrolling="no" frameborder="0"></iframe> 
    </div>
    <div class="separator">
    </div>
<div class="thepage">

<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
  <div class="navpath"><a class="el" href="group__vortex__listener.html">Vortex Listener: Set of functions to create BEEP Listeners (server applications that accept incoming requests)</a>
  </div>
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td valign="top">
      <div class="navtab">
        <table>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga44fb52915f48f42e83093fd77dc2588c.html#ga44fb52915f48f42e83093fd77dc2588c">vortex_listener_accept</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga650166dd5c68531eafe86a5e1ac6d2cc.html#ga650166dd5c68531eafe86a5e1ac6d2cc">vortex_listener_accept_connection</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga45e953f0d041818e6b9205386ac4a6a3.html#ga45e953f0d041818e6b9205386ac4a6a3">vortex_listener_get_default_realm</a></td></tr>
          <tr><td class="navtab"><a class="qindexHL" href="group__vortex__listener_ga9745c0a637eb270f60b290efe5193352.html#ga9745c0a637eb270f60b290efe5193352">vortex_listener_new</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga0d5bc3a8c97c3c3378dd1e7dab85e7ef.html#ga0d5bc3a8c97c3c3378dd1e7dab85e7ef">vortex_listener_new2</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga5408ed5b84fbf1895313ad5eb93bf80b.html#ga5408ed5b84fbf1895313ad5eb93bf80b">vortex_listener_new_full</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga5172fc33ab2b1a4bebdf50d02780fc40.html#ga5172fc33ab2b1a4bebdf50d02780fc40">vortex_listener_parse_conf_and_start</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_gadcc55f5e81614daf310afa92f9e8c763.html#gadcc55f5e81614daf310afa92f9e8c763">vortex_listener_send_greetings_on_connect</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_gaf41051b6c2436adda7f7f40e05b33f7a.html#gaf41051b6c2436adda7f7f40e05b33f7a">vortex_listener_set_default_realm</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_gae997c972c5e7b00f2d36ca9367c41eea.html#gae997c972c5e7b00f2d36ca9367c41eea">vortex_listener_set_on_connection_accepted</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga425cce7d2ed2d33e4439a080b16bd7c3.html#ga425cce7d2ed2d33e4439a080b16bd7c3">vortex_listener_shutdown</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga1fb4a1beffed623a0da24aef0bc35696.html#ga1fb4a1beffed623a0da24aef0bc35696">vortex_listener_sock_listen</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_gac8099641514b48769b63b0ef1c85064f.html#gac8099641514b48769b63b0ef1c85064f">vortex_listener_unlock</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__vortex__listener_ga8c905a74e007c89508b3add33e595c53.html#ga8c905a74e007c89508b3add33e595c53">vortex_listener_wait</a></td></tr>
        </table>
      </div>
   </td>
   <td valign="top">
<a class="anchor" id="ga9745c0a637eb270f60b290efe5193352"></a><!-- doxytag: member="vortex_listener.c::vortex_listener_new" ref="ga9745c0a637eb270f60b290efe5193352" args="(VortexCtx *ctx, const char *host, const char *port, VortexListenerReady on_ready, axlPointer user_data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__vortex__types_gac16883b703d1e546d54108153d4060b4.html#gac16883b703d1e546d54108153d4060b4">VortexConnection</a> * vortex_listener_new </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__vortex__types_ga879b03a2476b60c5b9b75489aabfe7db.html#ga879b03a2476b60c5b9b75489aabfe7db">VortexCtx</a> *&nbsp;</td>
          <td class="paramname"> <em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>host</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>port</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__vortex__handlers_ga0a0d19a89ed42acd50ff74821eb08513.html#ga0a0d19a89ed42acd50ff74821eb08513">VortexListenerReady</a>&nbsp;</td>
          <td class="paramname"> <em>on_ready</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">axlPointer&nbsp;</td>
          <td class="paramname"> <em>user_data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Creates a new Vortex Listener accepting incoming connections on the given <b>host:port</b> configuration. </p>
<p>If user provides an <a class="el" href="group__vortex__handlers_ga0a0d19a89ed42acd50ff74821eb08513.html#ga0a0d19a89ed42acd50ff74821eb08513">on_ready</a> callback, the listener will be notified on it, in a separated thread, once the process has finished. Check <a class="el" href="group__vortex__handlers_ga0a0d19a89ed42acd50ff74821eb08513.html#ga0a0d19a89ed42acd50ff74821eb08513">VortexListenerReady</a> handler documentation which is on_ready handler type.</p>
<p>On that notification will also be passed the host and port actually allocated. Think about using as host 0.0.0.0 and port 0. These values will cause to <a class="el" href="group__vortex__listener_ga9745c0a637eb270f60b290efe5193352.html#ga9745c0a637eb270f60b290efe5193352">vortex_listener_new</a> to allocate the system configured hostname and a random free port. See <a class="el" href="group__vortex__handlers.html">this section</a> for more info about on_ready parameter.</p>
<p>Host and port value provided to this function could be unrefered once returning from this function. The function performs a local copy for those values, that are deallocated at the appropriate moment.</p>
<p>Keep in mind that you can actually call several times to this function before calling to <a class="el" href="group__vortex__listener_ga8c905a74e007c89508b3add33e595c53.html#ga8c905a74e007c89508b3add33e595c53">vortex_listener_wait</a>, to make your process to be able to accept connections from several ports and host names at the same time.</p>
<p>While providing the port information, make sure your process will have enough rights to allocate the port provided. Usually, ports from 1 to 1024 are reserved to listener programms that runs with priviledges.</p>
<p>There is an alternative API that perform the same function but receive the TCP port value as integer: <a class="el" href="group__vortex__listener_ga0d5bc3a8c97c3c3378dd1e7dab85e7ef.html#ga0d5bc3a8c97c3c3378dd1e7dab85e7ef">vortex_listener_new2</a></p>
<p>In the case the optional handler <b>on_ready</b> is not provided, the function will return a reference to the <a class="el" href="group__vortex__types_gac16883b703d1e546d54108153d4060b4.html#gac16883b703d1e546d54108153d4060b4">VortexConnection</a> representing the listener created. This reference will have the role <a class="el" href="group__vortex__types_ga0ab21d5bd540acb9393030e6bf7d0582.html#gga0ab21d5bd540acb9393030e6bf7d0582aea8c80d6ff320174cdd466dad1263845">VortexRoleMasterListener</a>, (using <a class="el" href="group__vortex__connection_ga0be7b3f8fe8b325900c9449c58e2ec1a.html#ga0be7b3f8fe8b325900c9449c58e2ec1a">vortex_connection_get_role</a>) to indicate that the connection reference is a listener.</p>
<p>In the case the <b>on_ready</b> handler is provided, the function will return NULL.</p>
<p>Here is an example to start a vortex listener server:</p>
<div class="fragment"><pre class="fragment"> <span class="comment">// On this example you&#39;ll find:</span>
 <span class="comment">//   - 3 handlers: frame_received, start_channel and</span>
 <span class="comment">//                 close_channel (which handle the event</span>
 <span class="comment">//                 they represent).</span>
 <span class="comment">//   - An entry point (main function) which creates a</span>
 <span class="comment">//     a simple listener server, using previous three</span>
 <span class="comment">//     basic handlers.</span>

 <span class="comment">// vortex context</span>
 <a class="code" href="group__vortex__types_ga879b03a2476b60c5b9b75489aabfe7db.html#ga879b03a2476b60c5b9b75489aabfe7db" title="Vortex library context.">VortexCtx</a> * ctx = NULL;

 <span class="comment">// a frame handler</span>
 <span class="keywordtype">void</span> frame_received (<a class="code" href="group__vortex__types_ga9dab9d627d67bfc4cccf2687725ee60f.html#ga9dab9d627d67bfc4cccf2687725ee60f" title="A Vortex Channel object.">VortexChannel</a>    * channel,
                      <a class="code" href="group__vortex__types_gac16883b703d1e546d54108153d4060b4.html#gac16883b703d1e546d54108153d4060b4" title="A Vortex Connection object (BEEP session representation).">VortexConnection</a> * connection,
                      <a class="code" href="group__vortex__types_gac830c777ca317921af4cf7c038dcf8b7.html#gac830c777ca317921af4cf7c038dcf8b7" title="A Vortex Frame object.">VortexFrame</a>      * frame,
                      axlPointer         user_data)
 {
        <span class="comment">// Received a frame from the remote side.</span>
        <span class="comment">// process it and reply to it if it is a MSG.</span>
        <span class="keywordflow">return</span>;
 }

 axl_bool  start_channel (<span class="keywordtype">int</span>                channel_num, 
                          <a class="code" href="group__vortex__types_gac16883b703d1e546d54108153d4060b4.html#gac16883b703d1e546d54108153d4060b4" title="A Vortex Connection object (BEEP session representation).">VortexConnection</a> * connection, 
                          axlPointer         user_data)
 {
        printf (<span class="stringliteral">&quot;Received an start message=%d!!\n&quot;</span>,
                 channel_num);
        <span class="comment">// if the async notifier returns axl_true, the channel</span>
        <span class="comment">// is implicitly created, if axl_false is returned the</span>
        <span class="comment">// channel creation is denied and a reply error</span>
        <span class="comment">// is sent.</span>
        <span class="keywordflow">return</span> axl_true;
 }

 axl_bool      close_channel (<span class="keywordtype">int</span>                channel_num, 
                              <a class="code" href="group__vortex__types_gac16883b703d1e546d54108153d4060b4.html#gac16883b703d1e546d54108153d4060b4" title="A Vortex Connection object (BEEP session representation).">VortexConnection</a> * connection, 
                              axlPointer         user_data)
 {
        printf (<span class="stringliteral">&quot;Got a close message notification!!\n&quot;</span>);

        <span class="comment">// if axl_true is returned, the channel is</span>
        <span class="comment">// accepted to be closed. Otherwise the channel</span>
        <span class="comment">// will not be closed and an error reply will be</span>
        <span class="comment">// sent to the remote peer.</span>
        <span class="keywordflow">return</span> axl_true;
 }
 <span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv) {

      <a class="code" href="group__vortex__types_gac16883b703d1e546d54108153d4060b4.html#gac16883b703d1e546d54108153d4060b4" title="A Vortex Connection object (BEEP session representation).">VortexConnection</a> * listener;

      <span class="comment">// create a context</span>
      ctx = <a class="code" href="group__vortex__ctx_gada9a1d87bfe28dd117f6d6b4356d6e31.html#gada9a1d87bfe28dd117f6d6b4356d6e31" title="Creates a new vortex execution context.">vortex_ctx_new</a> ();

      <span class="comment">// enable log to see whats going on </span>
      <a class="code" href="group__vortex_ga0654f9e424a2b91d74b0b66be997c400.html#ga0654f9e424a2b91d74b0b66be997c400" title="Enable console vortex log.">vortex_log_enable</a> (ctx, axl_true);

      <span class="comment">// init vortex library (and check its result!)</span>
      <span class="keywordflow">if</span> (! <a class="code" href="group__vortex_ga3f5c9f2cc368c38589d0ab24ed909280.html#ga3f5c9f2cc368c38589d0ab24ed909280" title="Context based vortex library init.">vortex_init_ctx</a> (ctx)) {
           printf (<span class="stringliteral">&quot;Unable to initialize vortex library\n&quot;</span>);
           exit (-1);
      }
 
      <span class="comment">// register a profile</span>
      <a class="code" href="group__vortex__profiles_ga090a544dbe5097f9608401c405f913ff.html#ga090a544dbe5097f9608401c405f913ff" title="Allows to register a new profile inside the Vortex Library.">vortex_profiles_register</a> (ctx, <span class="stringliteral">&quot;http://vortex.aspl.es/profiles/example&quot;</span>, 
                                start_channel, NULL,
                                close_channel, NULL,
                                frame_received, NULL);
 
      <span class="comment">// now create a vortex server</span>
      listener = <a class="code" href="group__vortex__listener_ga9745c0a637eb270f60b290efe5193352.html#ga9745c0a637eb270f60b290efe5193352" title="Creates a new Vortex Listener accepting incoming connections on the given host:port...">vortex_listener_new</a> (ctx, <span class="stringliteral">&quot;0.0.0.0&quot;</span>, <span class="stringliteral">&quot;3000&quot;</span>, NULL, NULL);
      <span class="keywordflow">if</span> (! <a class="code" href="group__vortex__connection_ga130045a0527441a1c20332cad32f0f4d.html#ga130045a0527441a1c20332cad32f0f4d" title="Allows to get current connection status.">vortex_connection_is_ok</a> (listener, axl_false)) {
             printf (<span class="stringliteral">&quot;ERROR: failed to start listener, error found (code: %d) %s\n&quot;</span>, 
                     <a class="code" href="group__vortex__connection_ga5d8167eeae86f794e72b98f37a22c18d.html#ga5d8167eeae86f794e72b98f37a22c18d" title="Returns the current status for the provided connection.">vortex_connection_get_status</a> (listener),
                     <a class="code" href="group__vortex__connection_ga61d4211a7519da025071c47e5dc4fedc.html#ga61d4211a7519da025071c47e5dc4fedc" title="Returns actual message status for the given connection.">vortex_connection_get_message</a> (listener));
             reutrn -1;
      } 
      
      <span class="comment">// wait for listener to finish (maybe due to vortex_exit call)</span>
      <a class="code" href="group__vortex__listener_ga8c905a74e007c89508b3add33e595c53.html#ga8c905a74e007c89508b3add33e595c53" title="Blocks a listener (or listeners) launched until vortex finish.">vortex_listener_wait</a> (ctx);
  
      <span class="comment">// end vortex internal subsystem (if no one have done it yet!)</span>
      vortex_ctx_exit (ctx, axl_true);
 
      <span class="comment">// that&#39;s all to start BEEPing!</span>
      <span class="keywordflow">return</span> 0;     
 }  
</pre></div><dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ctx</em>&nbsp;</td><td>The context where the operation will be performed.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>host</em>&nbsp;</td><td>The host to listen on.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>port</em>&nbsp;</td><td>The port to listen on.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>on_ready</em>&nbsp;</td><td>A optional callback to get a notification when vortex listener is ready to accept requests.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>user_data</em>&nbsp;</td><td>A user defined pointer to be passed in to <em>on_ready</em> handler.</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>The listener connection created (represented by a <a class="el" href="group__vortex__types_gac16883b703d1e546d54108153d4060b4.html#gac16883b703d1e546d54108153d4060b4">VortexConnection</a> reference). You must use <a class="el" href="group__vortex__connection_ga130045a0527441a1c20332cad32f0f4d.html#ga130045a0527441a1c20332cad32f0f4d">vortex_connection_is_ok</a> to check if the server was started.</dd></dl>
<p><b>NOTE:</b> the reference returned is only owned by the vortex engine. This is not the case of <a class="el" href="group__vortex__connection_ga727b938695d1037058256e3559d9d599.html#ga727b938695d1037058256e3559d9d599">vortex_connection_new</a> where the caller acquires automatically a reference to the connection (as well as the vortex engine).</p>
<p>In this case, if your intention is to keep a reference for later operations, you must call to <a class="el" href="group__vortex__connection_gafbc3eee0f3da290c25d79d5cf846c695.html#gafbc3eee0f3da290c25d79d5cf846c695">vortex_connection_ref</a> to avoid losing the reference if the system drops the connection. In the same direction, you can't call to <a class="el" href="group__vortex__connection_gaa2cfa2eb776f65ce6805247f53cc1067.html#gaa2cfa2eb776f65ce6805247f53cc1067">vortex_connection_close</a> if you don't own the reference returned by this function.</p>
<p>To close immediately a listener you can use <a class="el" href="group__vortex__connection_gab19d868aff60285edd5fcadc03c65463.html#gab19d868aff60285edd5fcadc03c65463">vortex_connection_shutdown</a>. In the case the listener was not started (because <a class="el" href="group__vortex__connection_ga130045a0527441a1c20332cad32f0f4d.html#ga130045a0527441a1c20332cad32f0f4d">vortex_connection_is_ok</a> returned axl_false), you must use <a class="el" href="group__vortex__connection_gaa2cfa2eb776f65ce6805247f53cc1067.html#gaa2cfa2eb776f65ce6805247f53cc1067">vortex_connection_close</a> to terminate the reference (NOT vortex_connection_shutdown).</p>
<p><b>Note about old connecting clients, previous to 1.1.3</b></p>
<p>Until Vortex Library 1.1.3, listener accepting incoming connections were sending the BEEP greetings reply just after the remote peer connects. However, this was changed to allow listener side developers to react, modify or deny greetings at such phase (<a class="el" href="group__vortex__types_gac798abf276ccde468ae53d9646acc689.html#ggac798abf276ccde468ae53d9646acc689a2545cfdde583cf15459cd50944f50a75">CONNECTION_STAGE_PROCESS_GREETINGS_FEATURES</a>), hooking into that event, waiting first for the client BEEP greetings (especially to check which features it is providing).</p>
<p>This behaviour causes problems with clients from previous releases which are waiting for the listener to issue its BEEP peer greetings (where the listener is also waiting) to issue theirs. That is, old client never connects because he never receives greetings from BEEP listener, and BEEP listener never sends its greetings because the client never sent its greetings (circular problem).</p>
<p>To solve this issue you can either update the connecting client software or configure your listener to don't wait for client greetings to send its greetings:</p>
<ul>
<li><a class="el" href="group__vortex__listener_gadcc55f5e81614daf310afa92f9e8c763.html#gadcc55f5e81614daf310afa92f9e8c763">vortex_listener_send_greetings_on_connect</a></li>
</ul>
<p>This problem do not affect to new clients connecting to old servers. </p>

</div>
</div>
    </td>
  </tr>
</table>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div>
<div class="lateral-ad">
  <iframe src="http://www.aspl.es/web-ads/index.php?hcolor=fdff4f&amp;fsize=10&amp;bg=555753&amp;fg=ffffff&amp;width=150&amp;type=vertical" height="420" align="middle" width="100%" scrolling="no" frameborder="0"></iframe>
</div>
<div class="footer">
<small>Vortex Library:  A BEEP (RFC3080/RFC3081) implementation. &nbsp; Copyright 2008 (C) Advanced Software Production Line, S.L.</small>
</div>
</body>
</html>

